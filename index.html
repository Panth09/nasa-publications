<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA Bioscience Research Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
            --primary-blue: #3B82F6;
            --accent-purple: #A855F7;
            --highlight-green: #10B981;
            --warning-orange: #F59E0B;
            --bg-dark: #0f172a;
            --card-bg: rgba(31, 41, 55, 0.6);
        }

        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1e3a8a 50%, var(--bg-dark) 100%);
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stat-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            backdrop-filter: blur(8px);
        }
        .stat-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
        }
        #network-graph {
            width: 100%;
            height: 700px;
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
        }
        .publication-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .publication-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(59, 130, 246, 0.4);
            border-color: var(--primary-blue);
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.8s ease-out; }
        .animate-slide-up { animation: fadeIn 1s ease-out; }
        .chart-wrapper { height: 22rem; position: relative; }
        .loading-spinner {
            border: 4px solid rgba(59, 130, 246, 0.3);
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-white min-h-screen">
    <div class="container mx-auto px-4 py-12 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-12 animate-fade-in">
            <h1 class="text-5xl md:text-6xl lg:text-7xl font-extrabold mb-4 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent drop-shadow-xl">
                üöÄ NASA Bioscience Research Explorer
            </h1>
            <p class="text-gray-200 text-xl md:text-2xl mb-2">Advanced Dashboard for Space Biology Insights</p>
            <p class="text-gray-400 text-base" id="headerStats">Loading data...</p>
        </header>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="loading-spinner"></div>
            <p class="text-gray-400 mt-4 text-xl">Loading publications from database...</p>
        </div>

        <!-- Main Content (hidden until loaded) -->
        <div id="mainContent" style="display: none;">
            <!-- Navigation Tabs -->
            <nav class="flex flex-wrap justify-center gap-4 mb-12" role="tablist">
                <button onclick="showTab('overview', event)" class="tab-btn px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-xl font-semibold transition-all duration-300 shadow-lg focus:outline-none focus:ring-2 ring-offset-2 ring-blue-500" role="tab" aria-selected="true">
                    üìä Overview
                </button>
                <button onclick="showTab('search', event)" class="tab-btn px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-semibold transition-all duration-300 shadow-lg focus:outline-none focus:ring-2 ring-offset-2 ring-blue-500" role="tab" aria-selected="false">
                    üîç Search & Explore
                </button>
                <button onclick="showTab('insights', event)" class="tab-btn px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-semibold transition-all duration-300 shadow-lg focus:outline-none focus:ring-2 ring-offset-2 ring-blue-500" role="tab" aria-selected="false">
                    üí° AI Insights
                </button>
                <button onclick="showTab('knowledge-graph', event)" class="tab-btn px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-semibold transition-all duration-300 shadow-lg focus:outline-none focus:ring-2 ring-offset-2 ring-blue-500" role="tab" aria-selected="false">
                    üï∏Ô∏è Knowledge Graph
                </button>
            </nav>

            <!-- TAB 1: OVERVIEW -->
            <section id="overview" class="tab-content active" role="tabpanel">
                <!-- Key Metrics -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                    <div class="stat-card bg-gradient-to-br from-blue-900 to-blue-800 rounded-xl p-6 shadow-2xl border border-blue-700/50 animate-slide-up">
                        <h3 class="text-blue-300 text-sm font-medium mb-2">üìö Total Publications</h3>
                        <p class="text-5xl font-bold text-white" id="totalPubs">0</p>
                    </div>
                    <div class="stat-card bg-gradient-to-br from-green-900 to-green-800 rounded-xl p-6 shadow-2xl border border-green-700/50 animate-slide-up">
                        <h3 class="text-green-300 text-sm font-medium mb-2">üß¨ Research Domains</h3>
                        <p class="text-5xl font-bold text-white" id="domainCount">0</p>
                    </div>
                    <div class="stat-card bg-gradient-to-br from-purple-900 to-purple-800 rounded-xl p-6 shadow-2xl border border-purple-700/50 animate-slide-up">
                        <h3 class="text-purple-300 text-sm font-medium mb-2">üî¨ Biological Systems</h3>
                        <p class="text-5xl font-bold text-white" id="systemCount">0</p>
                    </div>
                    <div class="stat-card bg-gradient-to-br from-orange-900 to-orange-800 rounded-xl p-6 shadow-2xl border border-orange-700/50 animate-slide-up">
                        <h3 class="text-orange-300 text-sm font-medium mb-2">üìÖ Avg Duration</h3>
                        <p class="text-5xl font-bold text-white" id="avgDuration">0</p>
                        <p class="text-orange-300 text-xs mt-1">days</p>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-gray-800/60 rounded-xl p-6 shadow-2xl border border-gray-700/50 backdrop-blur-sm animate-slide-up">
                        <h3 class="text-2xl font-bold mb-6 text-blue-400">üìà Publications Timeline</h3>
                        <div class="chart-wrapper">
                            <canvas id="yearChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-800/60 rounded-xl p-6 shadow-2xl border border-gray-700/50 backdrop-blur-sm animate-slide-up">
                        <h3 class="text-2xl font-bold mb-6 text-green-400">ü¶† Organisms Distribution</h3>
                        <div class="chart-wrapper">
                            <canvas id="organismChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 2 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-800/60 rounded-xl p-6 shadow-2xl border border-gray-700/50 backdrop-blur-sm animate-slide-up">
                        <h3 class="text-2xl font-bold mb-6 text-purple-400">üî¨ Research Areas</h3>
                        <div class="chart-wrapper">
                            <canvas id="researchAreaChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-800/60 rounded-xl p-6 shadow-2xl border border-gray-700/50 backdrop-blur-sm animate-slide-up">
                        <h3 class="text-2xl font-bold mb-6 text-orange-400">üöÄ Space Conditions</h3>
                        <div class="chart-wrapper">
                            <canvas id="conditionChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- TAB 2: SEARCH & EXPLORE -->
            <section id="search" class="tab-content" role="tabpanel">
                <!-- Search Bar Only -->
                <div class="mb-8">
                    <label for="searchInput" class="sr-only">Search publications</label>
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="üîç Search by title, abstract, key findings..." 
                        class="w-full px-6 py-4 bg-gray-800/60 border-2 border-gray-700 rounded-xl text-white focus:outline-none focus:border-blue-500 transition-all duration-300 backdrop-blur-sm shadow-lg"
                        oninput="debouncedFilterPublications()"
                    >
                    <p class="text-gray-400 text-sm mt-2">Enter keywords to filter publications in real-time.</p>
                </div>

                <!-- Results -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-white">Publications</h2>
                    <p class="text-gray-400 mt-1" id="resultCount">0 publications</p>
                </div>
                
                <div id="publicationsList" class="space-y-6 max-h-[600px] overflow-y-auto pr-2 scrollbar-thin" role="list"></div>

                <!-- Load More Button -->
                <div class="text-center mt-8">
                    <button onclick="loadMore()" id="loadMoreBtn" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-all duration-300 shadow-lg focus:outline-none focus:ring-2 ring-offset-2 ring-blue-500">
                        Load More Publications
                    </button>
                </div>
            </section>

            <!-- TAB 3: AI INSIGHTS -->
            <section id="insights" class="tab-content" role="tabpanel">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Knowledge Gaps -->
                    <div class="bg-gray-800/60 rounded-xl p-6 shadow-2xl border border-gray-700/50 backdrop-blur-sm animate-slide-up">
                        <h3 class="text-2xl font-bold mb-4 text-yellow-400">üîç Knowledge Gaps</h3>
                        <p class="text-gray-400 mb-4">Underrepresented combinations (&lt;5 publications)</p>
                        <div class="space-y-3 max-h-80 overflow-y-auto scrollbar-thin" id="knowledgeGaps"></div>
                        <div class="mt-6 bg-yellow-900/30 rounded-lg p-4 border border-yellow-700/50">
                            <p class="text-yellow-200">üí° Investment opportunities for future funding</p>
                        </div>
                    </div>

                    <!-- Consensus Areas -->
                    <div class="bg-gray-800/60 rounded-xl p-6 shadow-2xl border border-gray-700/50 backdrop-blur-sm animate-slide-up">
                        <h3 class="text-2xl font-bold mb-4 text-green-400">‚úÖ Consensus Areas</h3>
                        <p class="text-gray-400 mb-4">Established areas (&gt;50 publications)</p>
                        <div class="space-y-3 max-h-80 overflow-y-auto scrollbar-thin" id="consensusAreas"></div>
                        <div class="mt-6 bg-green-900/30 rounded-lg p-4 border border-green-700/50">
                            <p class="text-green-200">üí° High confidence with substantial backing</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                    <!-- Recent Trends -->
                    <div class="bg-gray-800/60 rounded-xl p-6 shadow-2xl border border-gray-700/50 backdrop-blur-sm animate-slide-up">
                        <h3 class="text-2xl font-bold mb-4 text-blue-400">üìà Recent Trends</h3>
                        <p class="text-gray-400 mb-4">Emerging areas (Last 5 years)</p>
                        <div class="space-y-3" id="recentTrends"></div>
                    </div>

                    <!-- Research Stage Distribution -->
                    <div class="bg-gray-800/60 rounded-xl p-6 shadow-2xl border border-gray-700/50 backdrop-blur-sm animate-slide-up">
                        <h3 class="text-2xl font-bold mb-4 text-purple-400">üéØ Research Maturity</h3>
                        <div class="chart-wrapper h-64">
                            <canvas id="stageChart"></canvas>
                        </div>
                        <div class="space-y-2 mt-4" id="stageDetails"></div>
                    </div>
                </div>

                <!-- Actionable Insights Section -->
                <section class="bg-gradient-to-r from-blue-900/80 to-purple-900/80 rounded-xl p-8 shadow-2xl border border-blue-700/50 backdrop-blur-sm animate-slide-up">
                    <h3 class="text-3xl font-bold mb-6 text-white text-center">üéØ Actionable Insights</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gray-800/70 rounded-lg p-6">
                            <h4 class="text-xl font-bold mb-3 text-blue-400">üë®‚Äçüî¨ For Scientists</h4>
                            <ul class="space-y-2 text-gray-300" id="scientistInsights"></ul>
                        </div>
                        <div class="bg-gray-800/70 rounded-lg p-6">
                            <h4 class="text-xl font-bold mb-3 text-purple-400">üíº For Managers</h4>
                            <ul class="space-y-2 text-gray-300" id="managerInsights"></ul>
                        </div>
                        <div class="bg-gray-800/70 rounded-lg p-6">
                            <h4 class="text-xl font-bold mb-3 text-orange-400">üöÄ For Mission Planners</h4>
                            <ul class="space-y-2 text-gray-300" id="missionInsights"></ul>
                        </div>
                    </div>
                </section>
            </section>

            <!-- TAB 4: KNOWLEDGE GRAPH -->
            <section id="knowledge-graph" class="tab-content" role="tabpanel">
                <div class="bg-gray-800/60 rounded-xl p-6 shadow-2xl border border-gray-700/50 mb-6 backdrop-blur-sm animate-slide-up">
                    <h3 class="text-2xl font-bold mb-4 text-purple-400">üï∏Ô∏è Research Relationship Network</h3>
                    <p class="text-gray-400 mb-2">Interactive connections between organisms, research areas, and space conditions.</p>
                    <p class="text-gray-500 text-sm">Drag nodes to explore ‚Ä¢ Hover for details ‚Ä¢ Node size represents publication count</p>
                </div>

                <div class="bg-gray-800/60 rounded-xl p-6 shadow-2xl border border-gray-700/50 mb-6 backdrop-blur-sm animate-slide-up">
                    <div id="network-graph"></div>
                </div>

                <!-- Legend -->
                <div class="bg-gray-800/60 rounded-xl p-6 shadow-2xl border border-gray-700/50 backdrop-blur-sm animate-slide-up">
                    <h4 class="font-bold mb-3 text-white">Legend</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded-full bg-blue-500"></div>
                            <span class="text-gray-300">Organisms</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded-full bg-purple-500"></div>
                            <span class="text-gray-300">Research Areas</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Conditions</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-0.5 bg-gray-400"></div>
                            <span class="text-gray-300">Connections</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, query, orderBy, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDbxPfySgHZq0kE_FbewTnIWioJPxwTqks",
            authDomain: "nasa-bio-engine.firebaseapp.com",
            projectId: "nasa-bio-engine",
            storageBucket: "nasa-bio-engine.firebasestorage.app",
            messagingSenderId: "463317555755",
            appId: "1:463317555755:web:d8f27286a31be14ea0686e",
            measurementId: "G-QN49G284KM"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function safeJsonParse(str, fallback = []) {
            if (!str || str === '') return fallback;
            try {
                return JSON.parse(str);
            } catch (e) {
                return fallback;
            }
        }

        let allPublications = [];
        let filteredPublications = [];
        let displayedCount = 10;
        let graphInitialized = false;
        let timeoutId;

        // Mock statistics from previous code
        const mockStats = {
            organism_counts: { Human: 300, Mouse: 250, Yeast: 200, Plant: 250 },
            research_area_counts: { 'Gene Expression': 250, 'Bone Health': 200, 'Muscle Atrophy': 180, 'Radiation Effects': 150, 'Immune Response': 220 },
            condition_counts: { Microgravity: 800, Radiation: 400, Hypergravity: 100 },
            year_distribution: Object.fromEntries(Array.from({length: 21}, (_, i) => [2005 + i, 20 + Math.floor(Math.random() * 50)])),
            knowledge_gaps: Array.from({length: 10}, (_, i) => ({ 
                combination: `${['Human', 'Mouse', 'Yeast', 'Plant'][i % 4]} + ${['Microgravity', 'Radiation', 'Hypergravity'][i % 3]}`, 
                publication_count: Math.floor(Math.random() * 4) + 1 
            })),
            consensus_areas: [
                { area: 'Gene Expression in Microgravity', publication_count: 125 },
                { area: 'Bone Density Loss', publication_count: 98 },
                { area: 'Immune System Changes', publication_count: 87 },
                { area: 'Muscle Atrophy Mechanisms', publication_count: 76 },
                { area: 'Radiation DNA Damage', publication_count: 65 }
            ],
            recent_trends: [
                { area: 'CRISPR Space Applications', recent_publications: 45 },
                { area: 'Microbiome in Space', recent_publications: 38 },
                { area: 'Plant Growth Systems', recent_publications: 35 },
                { area: 'Tissue Engineering', recent_publications: 32 },
                { area: 'Genetic Adaptations', recent_publications: 28 },
                { area: 'Cellular Aging', recent_publications: 25 },
                { area: 'Stem Cell Research', recent_publications: 22 },
                { area: 'Circadian Rhythms', recent_publications: 18 }
            ],
            stage_distribution: { Exploratory: 200, Applied: 500, Translational: 300 }
        };

        async function loadPublications() {
            try {
                const publicationsRef = collection(db, 'publications');
                const q = query(publicationsRef, orderBy('created_at', 'desc'));
                const querySnapshot = await getDocs(q);

                allPublications = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allPublications.push({
                        id: doc.id,
                        title: data.title || 'Untitled',
                        abstract: data.abstract || '',
                        link: data.link || '#',
                        publication_year: data.publication_year || null,
                        experiment_duration_days: data.experiment_duration_days || null,
                        research_domains: safeJsonParse(data.research_domains),
                        biological_systems: safeJsonParse(data.biological_systems),
                        key_findings: safeJsonParse(data.key_findings)
                    });
                });

                filteredPublications = [...allPublications];

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

                calculateStatistics();
                displayPublications();
                initCharts();
                populateInsights();

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingState').innerHTML = `
                    <p class="text-red-400 text-xl">Error loading publications.</p>
                `;
            }
        }

        function calculateStatistics() {
            const total = allPublications.length;
            
            const domains = new Set();
            allPublications.forEach(pub => {
                pub.research_domains.forEach(d => domains.add(d));
            });

            const systems = new Set();
            allPublications.forEach(pub => {
                pub.biological_systems.forEach(s => systems.add(s));
            });

            const validDurations = allPublications.filter(p => p.experiment_duration_days).map(p => p.experiment_duration_days);
            const avgDuration = validDurations.length > 0 
                ? Math.round(validDurations.reduce((a, b) => a + b, 0) / validDurations.length)
                : 0;

            document.getElementById('totalPubs').textContent = total;
            document.getElementById('domainCount').textContent = domains.size;
            document.getElementById('systemCount').textContent = systems.size;
            document.getElementById('avgDuration').textContent = avgDuration;
            document.getElementById('headerStats').textContent = `Analyzing ${total} Publications ‚Ä¢ ${domains.size} Research Domains ‚Ä¢ Powered by AI`;
        }

        function debounce(func, delay) {
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        window.debouncedFilterPublications = debounce(() => {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                filteredPublications = [...allPublications];
            } else {
                filteredPublications = allPublications.filter(pub => {
                    const text = `${pub.title} ${pub.abstract} ${pub.key_findings.join(' ')}`.toLowerCase();
                    return text.includes(searchTerm);
                });
            }

            displayedCount = 10;
            displayPublications();
        }, 300);

        function displayPublications() {
            const container = document.getElementById('publicationsList');
            const toShow = filteredPublications.slice(0, displayedCount);

            if (toShow.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-400">No publications found matching your search.</div>';
                document.getElementById('resultCount').textContent = '0 publications';
                document.getElementById('loadMoreBtn').style.display = 'none';
                return;
            }

            container.innerHTML = toShow.map(pub => `
                <div class="publication-card bg-gray-800/60 rounded-xl p-6 border-2 border-gray-700/50 shadow-xl backdrop-blur-sm animate-slide-up">
                    <h3 class="text-xl font-bold mb-3 text-blue-400 line-clamp-2">${pub.title}</h3>
                    <div class="flex flex-wrap gap-2 mb-3">
                        ${pub.publication_year ? `<span class="px-3 py-1 bg-gray-700 text-gray-300 rounded-full text-xs">üìÖ ${pub.publication_year}</span>` : ''}
                        ${pub.experiment_duration_days ? `<span class="px-3 py-1 bg-gray-700 text-gray-300 rounded-full text-xs">‚è±Ô∏è ${pub.experiment_duration_days} days</span>` : ''}
                        <a href="${pub.link}" target="_blank" rel="noopener noreferrer" class="px-3 py-1 bg-blue-700 text-blue-200 rounded-full text-xs hover:bg-blue-600 transition-colors">üîó View</a>
                    </div>
                    <p class="text-gray-300 mb-4 leading-relaxed text-sm line-clamp-3">${pub.abstract || 'No abstract available.'}</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        ${pub.research_domains.slice(0, 3).map(d => `<span class="px-3 py-1 bg-blue-900 text-blue-200 rounded-full text-xs font-medium">üî¨ ${d.replace(/_/g, ' ')}</span>`).join('')}
                        ${pub.biological_systems.slice(0, 2).map(s => `<span class="px-3 py-1 bg-purple-900 text-purple-200 rounded-full text-xs font-medium">üß¨ ${s.replace(/_/g, ' ')}</span>`).join('')}
                    </div>
                    ${pub.key_findings.length > 0 ? `
                        <div class="mt-3 pt-3 border-t border-gray-700">
                            <p class="text-gray-400 text-xs font-semibold mb-2">Key Findings:</p>
                            <ul class="list-disc list-inside text-gray-300 text-xs space-y-1">
                                ${pub.key_findings.slice(0, 2).map(f => `<li class="line-clamp-1">${f}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `).join('');

            document.getElementById('resultCount').textContent = `${filteredPublications.length} publication${filteredPublications.length !== 1 ? 's' : ''} found`;
            document.getElementById('loadMoreBtn').style.display = displayedCount >= filteredPublications.length ? 'none' : 'block';
        }

        window.loadMore = function() {
            displayedCount += 10;
            displayPublications();
            document.getElementById('publicationsList').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        };

        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#D1D5DB',
                            font: { size: 14, family: 'Inter' },
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.9)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#3B82F6',
                        borderWidth: 1,
                        padding: 12
                    }
                },
                animation: { duration: 2000, easing: 'easeInOutQuart' }
            };

            // Year Timeline
            const yearLabels = Object.keys(mockStats.year_distribution).sort();
            new Chart(document.getElementById('yearChart'), {
                type: 'line',
                data: {
                    labels: yearLabels,
                    datasets: [{
                        label: 'Publications per Year',
                        data: yearLabels.map(y => mockStats.year_distribution[y]),
                        backgroundColor: 'rgba(59, 130, 246, 0.3)',
                        borderColor: '#3B82F6',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#3B82F6',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#9CA3AF', font: { family: 'Inter' } },
                            grid: { color: '#374151', drawBorder: false }
                        },
                        x: {
                            ticks: { color: '#9CA3AF', font: { family: 'Inter' } },
                            grid: { display: false }
                        }
                    }
                }
            });

            // Organism Distribution
            new Chart(document.getElementById('organismChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(mockStats.organism_counts),
                    datasets: [{
                        data: Object.values(mockStats.organism_counts),
                        backgroundColor: ['#10B981', '#8B5CF6', '#F59E0B', '#EF4444'],
                        borderWidth: 2,
                        borderColor: '#1F2937',
                        hoverOffset: 20
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        legend: { position: 'bottom' }
                    },
                    cutout: '60%'
                }
            });

            // Research Area
            const topAreas = Object.entries(mockStats.research_area_counts).sort((a, b) => b[1] - a[1]);
            new Chart(document.getElementById('researchAreaChart'), {
                type: 'bar',
                data: {
                    labels: topAreas.map(([area]) => area),
                    datasets: [{
                        label: 'Publications',
                        data: topAreas.map(([, count]) => count),
                        backgroundColor: '#A855F7',
                        borderColor: '#9333EA',
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: {
                    ...commonOptions,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { color: '#9CA3AF', font: { family: 'Inter' } },
                            grid: { color: '#374151', drawBorder: false }
                        },
                        y: {
                            ticks: { color: '#9CA3AF', font: { family: 'Inter' } },
                            grid: { display: false }
                        }
                    },
                    plugins: { ...commonOptions.plugins, legend: { display: false } }
                }
            });

            // Space Conditions
            new Chart(document.getElementById('conditionChart'), {
                type: 'polarArea',
                data: {
                    labels: Object.keys(mockStats.condition_counts),
                    datasets: [{
                        data: Object.values(mockStats.condition_counts),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.7)',
                            'rgba(16, 185, 129, 0.7)',
                            'rgba(245, 158, 11, 0.7)'
                        ],
                        borderWidth: 2,
                        borderColor: '#1F2937'
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        r: {
                            ticks: { color: '#9CA3AF', backdropColor: 'transparent', font: { family: 'Inter' } },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });

            // Stage Distribution
            new Chart(document.getElementById('stageChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(mockStats.stage_distribution),
                    datasets: [{
                        data: Object.values(mockStats.stage_distribution),
                        backgroundColor: ['#3B82F6', '#8B5CF6', '#10B981'],
                        borderWidth: 2,
                        borderColor: '#1F2937',
                        hoverOffset: 20
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function populateInsights() {
            // Knowledge Gaps
            document.getElementById('knowledgeGaps').innerHTML = mockStats.knowledge_gaps.map(gap => `
                <div class="bg-gray-700/50 rounded-lg p-4 border-l-4 border-yellow-500 animate-slide-up">
                    <p class="font-semibold text-white">${gap.combination}</p>
                    <p class="text-sm text-gray-400">${gap.publication_count} publication${gap.publication_count !== 1 ? 's' : ''}</p>
                </div>
            `).join('');

            // Consensus Areas
            document.getElementById('consensusAreas').innerHTML = mockStats.consensus_areas.map(area => `
                <div class="bg-gray-700/50 rounded-lg p-4 border-l-4 border-green-500 animate-slide-up">
                    <div class="flex justify-between items-center">
                        <p class="font-semibold text-white">${area.area}</p>
                        <span class="px-3 py-1 bg-green-900 text-green-200 rounded-full text-xs font-bold">${area.publication_count}</span>
                    </div>
                </div>
            `).join('');

            // Recent Trends
            const maxPubs = Math.max(...mockStats.recent_trends.map(t => t.recent_publications));
            document.getElementById('recentTrends').innerHTML = mockStats.recent_trends.map((trend, i) => `
                <div class="bg-gray-700/50 rounded-lg p-3 animate-slide-up">
                    <div class="flex justify-between items-center mb-2">
                        <p class="font-semibold text-white">${trend.area}</p>
                        <span class="text-blue-400 font-bold">${trend.recent_publications}</span>
                    </div>
                    <div class="w-full bg-gray-600 rounded-full h-2.5">
                        <div class="bg-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: ${(trend.recent_publications / maxPubs) * 100}%"></div>
                    </div>
                </div>
            `).join('');

            // Stage Details
            document.getElementById('stageDetails').innerHTML = Object.entries(mockStats.stage_distribution).map(([stage, count]) => `
                <div class="flex justify-between items-center animate-slide-up">
                    <span class="text-gray-400">${stage}</span>
                    <span class="text-white font-bold">${count} (${Math.round((count / 1000) * 100)}%)</span>
                </div>
            `).join('');

            // Actionable Insights
            document.getElementById('scientistInsights').innerHTML = `
                <li>‚Ä¢ ${allPublications.length} total publications</li>
                <li>‚Ä¢ ${mockStats.knowledge_gaps.length} underexplored areas</li>
                <li>‚Ä¢ Strong foundation in gene expression</li>
                <li>‚Ä¢ Focus on emerging CRISPR applications</li>
            `;

            document.getElementById('managerInsights').innerHTML = `
                <li>‚Ä¢ ${mockStats.consensus_areas.length} established research areas</li>
                <li>‚Ä¢ ${mockStats.knowledge_gaps.length} funding opportunities</li>
                <li>‚Ä¢ High ROI in microgravity research</li>
                <li>‚Ä¢ 5 mature areas ready for translation</li>
            `;

            document.getElementById('missionInsights').innerHTML = `
                <li>‚Ä¢ ${allPublications.length} mission-relevant publications</li>
                <li>‚Ä¢ Focus: bone, muscle, radiation</li>
                <li>‚Ä¢ ISS data applicable to Moon/Mars</li>
                <li>‚Ä¢ Critical gaps in long-duration effects</li>
            `;
        }

        window.showTab = function(tabId, event) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                btn.setAttribute('aria-selected', 'false');
            });
            document.getElementById(tabId).classList.add('active');
            if (event) {
                event.target.classList.add('bg-blue-600', 'hover:bg-blue-700');
                event.target.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                event.target.setAttribute('aria-selected', 'true');
            }
            if (tabId === 'knowledge-graph' && !graphInitialized) {
                setTimeout(initKnowledgeGraph, 100);
                graphInitialized = true;
            }
        };

        function initKnowledgeGraph() {
            const container = document.getElementById('network-graph');
            container.innerHTML = '';
            
            const width = container.clientWidth;
            const height = 700;

            const nodes = [
                ...Object.keys(mockStats.organism_counts).map((org, i) => ({
                    id: org,
                    type: 'organism',
                    value: mockStats.organism_counts[org]
                })),
                ...Object.keys(mockStats.research_area_counts).map((area, i) => ({
                    id: area,
                    type: 'area',
                    value: mockStats.research_area_counts[area]
                })),
                ...Object.keys(mockStats.condition_counts).map((cond, i) => ({
                    id: cond,
                    type: 'condition',
                    value: mockStats.condition_counts[cond]
                }))
            ];

            const links = [];
            Object.keys(mockStats.organism_counts).forEach(org => {
                Object.keys(mockStats.research_area_counts).forEach(area => {
                    if (Math.random() > 0.3) {
                        links.push({ source: org, target: area, value: Math.floor(Math.random() * 50) + 10 });
                    }
                });
                Object.keys(mockStats.condition_counts).forEach(cond => {
                    if (Math.random() > 0.5) {
                        links.push({ source: org, target: cond, value: Math.floor(Math.random() * 100) + 50 });
                    }
                });
            });

            const svg = d3.select('#network-graph')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', `0 0 ${width} ${height}`)
                .attr('preserveAspectRatio', 'xMidYMid meet');

            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(200))
                .force('charge', d3.forceManyBody().strength(-400))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(60));

            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .join('line')
                .attr('stroke', '#6B7280')
                .attr('stroke-opacity', 0.7)
                .attr('stroke-width', d => Math.sqrt(d.value) / 1.5);

            const node = svg.append('g')
                .selectAll('g')
                .data(nodes)
                .join('g')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))
                .on('mouseover', function(event, d) {
                    d3.select(this).select('circle').attr('stroke-width', 4);
                    d3.select(this).select('text').attr('font-size', '12px');
                })
                .on('mouseout', function(event, d) {
                    d3.select(this).select('circle').attr('stroke-width', 2);
                    d3.select(this).select('text').attr('font-size', '10px');
                });

            node.append('circle')
                .attr('r', d => Math.sqrt(d.value) * 2.5)
                .attr('fill', d => {
                    if (d.type === 'organism') return '#3B82F6';
                    if (d.type === 'area') return '#A855F7';
                    return '#10B981';
                })
                .attr('stroke', '#fff')
                .attr('stroke-width', 2);

            node.append('text')
                .text(d => d.id)
                .attr('x', 0)
                .attr('y', 5)
                .attr('text-anchor', 'middle')
                .attr('fill', '#fff')
                .attr('font-size', '10px')
                .attr('font-weight', 'bold')
                .attr('font-family', 'Inter')
                .attr('pointer-events', 'none');

            node.append('title')
                .text(d => `${d.id}\n${d.value} publications`);

            simulation.on('tick', () => {
                link
                    .attr('x1', d => Math.max(20, Math.min(width - 20, d.source.x)))
                    .attr('y1', d => Math.max(20, Math.min(height - 20, d.source.y)))
                    .attr('x2', d => Math.max(20, Math.min(width - 20, d.target.x)))
                    .attr('y2', d => Math.max(20, Math.min(height - 20, d.target.y)));

                node.attr('transform', d => `translate(${Math.max(20, Math.min(width - 20, d.x))},${Math.max(20, Math.min(height - 20, d.y))})`);
            });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            window.addEventListener('resize', () => {
                const newWidth = document.getElementById('network-graph').clientWidth;
                svg.attr('width', newWidth);
                simulation.force('center', d3.forceCenter(newWidth / 2, height / 2));
                simulation.alpha(0.5).restart();
            });
        }

        document.addEventListener('DOMContentLoaded', loadPublications);
    </script>
</body>
</html>